<!DOCTYPE html>
<html lang="en">
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=620">
<title>HTML5 Demo: File API</title>

<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>-->

<script src="http://code.jquery.com/jquery-1.9.1.js"></script>

<style>
body {
  font: 10px sans-serif;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.point {
  stroke: #000;
}

#container {

  border: 10px #ccc; 
  width: 862px; 
  max-height: 900px; 
  margin: 20px auto;

}

#leftBar {
  background-color:#C0D9D9; 
  text-align: center;
  vertical-align: middle;   
  float:left;
  border: 10px #ccc; 
  width: 250px; 
  max-height: 900px;
  padding-right: 2px;
  
  margin: 20px auto;

}
#leftBar ul { margin:0px; padding:0px; }
 
ul.top-level { background:#666; }
ul.top-level li {
 border-bottom: #fff solid;
 border-top: #fff solid;
 border-width: 1px;
}
 
#leftBar li {
 border:1px solid #000;
 list-style: none;
 color: #fff;
 background: #87421F;
 display:block;
 height:45px;
 line-height: 55px;
 text-indent: 4px;
 text-decoration:none;
 width:100%;


}
 
#leftBar li:hover {
 background: #f90;
 position: relative;
}
#leftBar li span {
  text-decoration: none;
  color: #000;
  display: block;
  width: 200px;
 
  -webkit-transition: font-size 0.3s ease, background-color 0.3s ease;
  -moz-transition: font-size 0.3s ease, background-color 0.3s ease;
  -o-transition: font-size 0.3s ease, background-color 0.3s ease;
  -ms-transition: font-size 0.3s ease, background-color 0.3s ease;
  transition: font-size 0.3s ease, background-color 0.3s ease;
}

#docDisplay {
  background-color:#ADEAEA;
  text-align: center;
  vertical-align: middle;   
  float:right;
  border: 10px #ccc; 
  width: 600px; 
  max-height: 900px;
  margin: 20px auto;

}

#holder { 
  background-color:#E8E8E8; 
  text-align: center;
  vertical-align: middle; 
  line-height: 300px;   
  clear:both;
  border: 10px dashed #ccc; 
  width: 300px; 
  height: 300px; 
  margin: 20px auto;
}

#holder.hover { 
  border: 10px dashed #333; 
  width: 300px; 
  height: 300px; 
  margin: 20px auto;
}
#holder.drop { 
  border: 10px dashed #333; 
  width: 100px; 
  height: 100px; 
  margin: 10px auto;
}

input.rounded {
    border: 1px solid #ccc;
    -moz-border-radius: 10px;
    -webkit-border-radius: 10px;
    border-radius: 10px;
    -moz-box-shadow: 2px 2px 3px #666;
    -webkit-box-shadow: 2px 2px 3px #666;
    box-shadow: 2px 2px 3px #666;
    font-size: 20px;
    padding: 4px 7px;
    outline: 0;
    -webkit-appearance: none;
}

input.rounded:focus {

    border-color: #339933;

}

#docDisplay{padding: 20px;
  background-color: #FFFFFF;
  width: 800px;
  line-height:200%;}
body{font-family: sans-serif;
  font-name: "Lucida Grande";}
.mentionStyle{font-size: 18px;
  font-weight: bold;
  opacity: 1;
  cursor: pointer;
  padding: 2px;
  } 
.textStyle{font-size: 16px;}
.inactive{opacity: 0.3;}
.guess {
text-shadow: 0 0 20px black;
}
.selected {border: 1px solid blue;
}
.incorrect {border-bottom: 2px solid red;}
#key{padding: 20px;}
.on.exterior{
  opacity: 1;
}


</style>

  <meta charset="utf-8">
  <title>Coreference Visualization</title>  

</head>

<body>
<article>
  

  <div id="container">
    <div id="leftBar">

      <!--<input id="searchBox" onkeypress="searchDoc()"/> -->
      
    </div>
    <!--<div id="docContent">
      <span id="contentSpan"></span>
    </div>-->
    <div id="docDisplay"></div> 
  </div>
  <div id="holder"><span id="feedMe">Feed me JSON file!</span></div> 
  <p id="status">File API & FileReader API not supported</p>
  <div id="key">
      Select a <span class="selected"><b>mention</b></span> to see its co-reference clusters.</br>
      Incorrectly clustered <span class="incorrect"><b>mentions</b></span> are underlined.</br>
      Gold clustered <span style="color:blue"><b>mentions</b></span> have the same <span style="color:blue"><b>color</b></span>.</br>
      Your <span class="guess" style="color:blue"><b>mention clusters</b></span> have the same <span class="guess" style="color:blue"><b>background</b></span>.</br>
  </div>
  <!--<p id="thejsonfile">nothing</p>-->
  <p id="theDocument"></p>
  
</article>
</body>

<script>

var holder = document.getElementById('holder'),
    thejsonfile = document.getElementById('thejsonfile'),
    state = document.getElementById('status'),
    docList = document.getElementById('doclist');

var thejsonobject;

//docList.style.visibility="hidden";

if (typeof window.FileReader === 'undefined') {
  state.className = 'fail';
} else {
  state.className = 'success';
  state.innerHTML = 'File API & FileReader available';
}
 
holder.ondragover = function () { this.className = 'hover'; document.getElementById('feedMe').innerHTML = 'drop it like its hot!'; return false; };
holder.ondragend = function () { this.className = 'nohover';document.getElementById('feedMe').innerHTML = 'Feed me JSON file!'; return false; };
holder.ondragleave = function (){ this.className = 'nohover'; document.getElementById('feedMe').innerHTML = 'Feed me JSON file!'; return false; };

holder.ondrop = function (e) {


  this.className = 'nohover';
  document.getElementById('feedMe').innerHTML = 'Feed me JSON file!';
  e.preventDefault();

  var file = e.dataTransfer.files[0],
      reader = new FileReader();


  reader.onload = function (event) {
    console.log(event.target);
    holder.style.background = 'url(' + event.target.result + ') no-repeat center';
  };

  console.log(file);
  reader.readAsText( file, "UTF-8" ) 
  state.innerHTML = 'GOTCHURFILE';
  reader.onload = function(e){

    //thejsonfile.innerHTML = reader.result;
    try {

      jsonArray = JSON.parse(reader.result);
      if(document.getElementById('searchBox')){
          document.getElementById('leftBar').innerHTML='';
          document.getElementById('doclist').innerHTML = '';

      }
      //docList.style.visibility="visible";
      
      //var contentSpan = document.getElementById('contentSpan');
      //contentSpan.innerHTML = '';
      $( "#docDisplay" ).text("");

      var mi = document.createElement("input");
      mi.setAttribute('type', 'text');
      mi.setAttribute('value', '');
      mi.setAttribute('onkeydown','checkForEmptyInput()');
      mi.setAttribute('onkeyup','searchDoc()');
      mi.setAttribute('className','rounded');
      mi.setAttribute('id','searchBox');

      document.getElementById('leftBar').appendChild(mi);
      
      var ul = document.createElement("ul");
      ul.setAttribute('className', 'top-level');
      ul.setAttribute('id', 'doclist');

      for (var i =0  ; i < jsonArray.length; i++) {
        
        var doc = jsonArray[i];
        //var ul = document.getElementById('doclist');

        var li = document.createElement("li");
        li.setAttribute("id", "li_"+i);
        //li.innerHTML= "<span>"+doc.id+"</span>";
        li.innerHTML=doc.id;

        ul.addEventListener("click",function(e) {
            // e.target is our targetted element.
            // try doing console.log(e.target.nodeName), it will result LI

            if(e.target && e.target.nodeName == "LI") {

                console.log(e.target.id + " was clicked");
                var re = /li_/gi;
                var docNumClicked = e.target.id.replace(re, "");
                //var contentSpan = document.getElementById('contentSpan');
                display(jsonArray[parseInt(docNumClicked)].content);
                //contentSpan.innerHTML = jsonArray[parseInt(docNumClicked)].content.string.join(" ");
            }
        });

        ul.appendChild(li);

        
        //$('#doclist').append('<li>Document: '+ doc.id +'</li>');
      };

      document.getElementById('leftBar').appendChild(ul);
      //var contentSpan = document.getElementById('contentSpan');
      //contentSpan.innerHTML = jsonArray[0].content.string.join(" ");
      display(jsonArray[0].content);

    }catch(e){
     console.error("Parsing error!!!:", e); 
    }

  };

  return false;
};


function addBackAllDocs(){
  for (var i =0  ; i < jsonArray.length; i++) {
        
        var doc = jsonArray[i];
        //var ul = document.getElementById('doclist');

        var li = document.createElement("li");
        li.setAttribute("id", "li_"+i);
        //li.innerHTML= "<span>"+doc.id+"</span>";
        li.innerHTML=doc.id;

        document.getElementById('doclist').addEventListener("click",function(e) {
            // e.target is our targetted element.
            // try doing console.log(e.target.nodeName), it will result LI

            if(e.target && e.target.nodeName == "LI") {

                console.log(e.target.id + " was clicked");
                var re = /li_/gi;
                var docNumClicked = e.target.id.replace(re, "");
                //var contentSpan = document.getElementById('contentSpan');
                //contentSpan.innerHTML = jsonArray[parseInt(docNumClicked)].content.string.join(" ");
                display(jsonArray[parseInt(docNumClicked)].content);
            }
        });

        document.getElementById('doclist').appendChild(li);

        
        //$('#doclist').append('<li>Document: '+ doc.id +'</li>');
      };
      //var contentSpan = document.getElementById('contentSpan');
      //contentSpan.innerHTML = jsonArray[0].content.string.join(" ");
      display(jsonArray[0].content);
}


function searchDoc(){

    document.getElementById('doclist').innerHTML='';
    var query = document.getElementById('searchBox').value;
    var firstIndex=-1;
    for (var i =0  ; i < jsonArray.length; i++) {
        
        var doc = jsonArray[i];
        //var ul = document.getElementById('doclist');

        if ((doc.id.indexOf(query) !== -1)||(doc.content.string.join(" ").indexOf(query) !== -1)){
          if (firstIndex==-1){
            firstIndex=i;
          }
          var li = document.createElement("li");
          li.setAttribute("id", "li_"+i);
          //li.innerHTML= "<span>"+doc.id+"</span>";
          li.innerHTML=doc.id;

          document.getElementById('doclist').addEventListener("click",function(e) {
              // e.target is our targetted element.
              // try doing console.log(e.target.nodeName), it will result LI

              if(e.target && e.target.nodeName == "LI") {

                  console.log(e.target.id + " was clicked");
                  var re = /li_/gi;
                  var docNumClicked = e.target.id.replace(re, "");
                  //var contentSpan = document.getElementById('contentSpan');
                  //contentSpan.innerHTML = jsonArray[parseInt(docNumClicked)].content.string.join(" ");
                  display(jsonArray[parseInt(docNumClicked)].content);
              }
          });

          document.getElementById('doclist').appendChild(li);
        }

        
        //$('#doclist').append('<li>Document: '+ doc.id +'</li>');
      };
      //var contentSpan = document.getElementById('contentSpan');
      //contentSpan.innerHTML = jsonArray[firstIndex].content.string.join(" ");
      display(jsonArray[0].content);
  

  
  //alert(document.getElementById('searchBox').value);

}

function checkForEmptyInput(){

   var KeyID = event.keyCode;
   if(document.getElementById('searchBox').value.length < 2 ){
     switch(KeyID)
     {
        case 8:
        addBackAllDocs();
        break; 
        case 46:
        addBackAllDocs();
        break;
        default:
        break;
     }
   }else{
    searchDoc();
   }


}


























//CODE STARTS HERE
var colorIdx=0;
var colorMap = [];
var colors = ["#E41A1C","#377EB8","#4DAF4A","#984EA3","#FF7F00","#A65628","#F781BF","#999999","#A6CEE3","#1F78B4","#B2DF8A","#33A02C","#FB9A99","#E31A1C","#FDBF6F","#FF7F00","#CAB2D6","#6A3D9A","#FFFF99"];
var currentMentionId = -1;
var mentionSpans=[];
var currentContent;
var interiorMentionClick = false;

//Return a color from the colors array for the given clusterId
function getColor(clusterId){
  //Check that you don't go past the end of colors array
  colorIdx = colorIdx == colors.length ? colors.length - 1 : colorIdx;
  //If clusterId hasnt been mapped to a color yet
  if (!colorMap[clusterId])
    colorMap[clusterId] = colors[colorIdx++];
  return colorMap[clusterId];
}

//Build a mention span
function getMentionSpan(mIdx){

  var span =  $(document.createElement('span'))
        .addClass( "mention" )
        .addClass( "mentionStyle" )
        .addClass( "gold"+currentContent.gold[mIdx] )
        .addClass( "guess"+currentContent.guess[mIdx] )
        .attr("id","m"+mIdx)
        .css("color",getColor(currentContent.gold[mIdx]));
  //mark incorrect
  if (currentContent.gold[mIdx] != currentContent.guess[mIdx])
    span.addClass("incorrect");
  return span;
}

function getIntersect(arr1,arr2) {
  var temp = new Array();
  for(var i = 0; i < arr1.length; i++){
    for(var k = 0; k < arr2.length; k++){
      if(arr1[i] == arr2[k]){
        temp[temp.length] = arr1[i];
      }
    }
  }
  return temp;
}

function clusterIndexArray(array){
  var idxArray = new Array();
  for (var i=0;i<array.length;i++){
    if (!idxArray[array[i]]){
      var id = array[i];
      //Build an array of the indices of the gold cluster
      idxArray[id] = new Array();
      idxArray[id][0] = jQuery.inArray(id,array);
      while (jQuery.inArray(id,array,idxArray[id][idxArray[id].length-1]+1)!=-1){
        idxArray[id].push(jQuery.inArray(id,array,idxArray[id][idxArray[id].length-1]+1));
      }
    }
  }
  return idxArray;
}

function updateEntityIds(){
  //For each gold cluster find the max overlap (greedy)
  var goldToGuessMap = [];
  //For each gold cluster build an array of its indices
  var goldIdxArray = clusterIndexArray(currentContent.gold);
  //For each guess cluster build an array of its indices
  var guessIdxArray = clusterIndexArray(currentContent.guess);
  //Build an array of the indices of the
  //Find maximum overlap for each cluster
  for (var i=0;i<goldIdxArray.length;i++){
    if (goldIdxArray[i]){
      var overlap=0;
      var guessClusterId=-1;
      for (var j=0;j<guessIdxArray.length;j++){
        if (guessIdxArray[j]){
          //Get overlap
          var curr = getIntersect(goldIdxArray[i],guessIdxArray[j]).length;
          if (curr > overlap){
            overlap = curr;
            guessClusterId = currentContent.guess[guessIdxArray[j][0]];
          }
        }
      }
      //Update all entity ids for given cluster
      if (guessClusterId>=0) {
        for (var j=0;j<currentContent.guess.length;j++){
          currentContent.guess[j] = (currentContent.guess[j] == guessClusterId) ? currentContent.gold[goldIdxArray[i][0]] : currentContent.guess[j];
        }
      }
    }
  }
}

//Display data from the content object
function display(content) {
  currentContent = content;
  updateEntityIds();
  //Clear the doc div
  $( "#docDisplay" ).text("");
  var idx=0;  
  for (var i=0;i<content.mentionStart.length;i++){
    //Add text in front of mention
    $( "#docDisplay" ).append($(document.createElement('span'))
      .addClass( "textStyle" )
      .append(content.string.slice(idx,content.mentionStart[i]).join(" "))).append(" ");
    idx = content.mentionStart[i];
    //Add mention
    mentionSpans[i] = getMentionSpan(i);
    $( "#docDisplay" ).append(mentionSpans[i]);
    //Check for interior mentions
    while (i < content.gold.length-1 && content.mentionEnd[i+1]<=content.mentionEnd[i]){
      mentionSpans[i].append(content.string.slice(idx,content.mentionStart[i+1]).join(" ")).append(" ");
      mentionSpans[i+1]=getMentionSpan(i+1);
      mentionSpans[i].append(mentionSpans[i+1]);
      //Mark as interior/exterior mention
      mentionSpans[i].addClass("exterior");
      mentionSpans[i+1].addClass("interior");
      i++;
      idx = content.mentionStart[i];
    }
    //Finish building mention
    mentionSpans[i].append(content.string.slice(idx,content.mentionEnd[i]).join(" ")).append(" ");
    idx = content.mentionEnd[i];
  }
}

//Toggle on/off mentions
function toggleMention(mention){
  var mIdx = parseInt(mention.id.substring(1));
  $( ".exterior" ).removeClass("on");
  if ($( "#m"+mIdx ).hasClass("interior")){
    interiorMentionClick = true;
  } else if (interiorMentionClick){
    //Turn on other exterior mentions
    $( ".gold"+currentContent.gold[mIdx] ).addClass("on");
    interiorMentionClick = false;
    return;
  }
  //Same mention was selected, reset display
  if (mIdx == currentMentionId){
    $( ".mention" ).removeClass("guess")
      .removeClass("inactive")
      .removeClass("guess")
      .removeClass("selected")
      .addClass("mentionStyle");
    currentMentionId = -1;
    $( ".textStyle" ).removeClass("inactive");
    return;
  } else {
    //Set mention to selected, make all mentions inactive
    $( "#m"+mIdx ).addClass( "selected" );
    $( ":not(#m"+mIdx+")" ).removeClass( "selected" );
    $( ".textStyle" ).addClass("inactive");
    $( ".mention" ).addClass("inactive")
          .removeClass("guess");
    currentMentionId = mIdx;
  }
  //Mark gold clusters
  $( ".gold"+currentContent.gold[mIdx]).removeClass( "inactive" )
        .addClass("mentionStyle");
  //Mark guess clusters
  $( ".guess"+currentContent.guess[mIdx]).removeClass( "inactive" )
        .addClass("guess");
}



$( ".mention" ).click(function( event ) {
  toggleMention(event.currentTarget);
});


</script>

</html>